#!/usr/bin/env python
import os
import sys
import django
from datetime import date, timedelta
from decimal import Decimal

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'tsz2.settings')
django.setup()

from main.models import User, Order, Tariff

def test_booking_fix():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    try:
        customer = User.objects.filter(user_type='customer').first()
        performer = User.objects.filter(user_type='performer', service_type__code='star').first()
        
        if not customer:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∑–∞–∫–∞–∑—á–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        if not performer:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
            
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∑–∞–∫–∞–∑—á–∏–∫: {customer.get_full_name()}")
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {performer.get_full_name()}")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        return
    
    # –¢–µ—Å—Ç: –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∏–º–∏—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∫–∞—Ç–∞–ª–æ–≥)
    print("\nüìã –¢–µ—Å—Ç: –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∫–∞—Ç–∞–ª–æ–≥")
    try:
        booking = Order.objects.create(
            customer=customer,
            performer=performer,
            title=f'–¢–µ—Å—Ç–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–∞—Ç–∞–ª–æ–≥',
            event_type='wedding',
            event_date=date.today() + timedelta(days=35),
            city=performer.city,
            venue='–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ª',
            guest_count=50,
            description='–¢–µ—Å—Ç–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
            budget_min=Decimal('50000'),
            budget_max=Decimal('100000'),
            services=[],
            details='–¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏',
            order_type='booking',
            status='new'  # ‚úÖ –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å 'new' –≤–º–µ—Å—Ç–æ 'in_progress'
        )
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: {booking.title}")
        print(f"   üìä –°—Ç–∞—Ç—É—Å: {booking.status}")
        print(f"   üìä –¢–∏–ø –∑–∞–∫–∞–∑–∞: {booking.order_type}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å"
        if booking.status == 'new' and booking.order_type == 'booking':
            print("   ‚úÖ –£ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏ '–ü—Ä–∏–Ω—è—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å'")
        else:
            print("   ‚ùå –õ–æ–≥–∏–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        return
    
    # –¢–µ—Å—Ç: –ü—Ä–∏–Ω—è—Ç–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    print("\nüìã –¢–µ—Å—Ç: –ü—Ä–∏–Ω—è—Ç–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º")
    try:
        booking.status = 'in_progress'
        booking.save()
        print(f"‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ (—Å—Ç–∞—Ç—É—Å: {booking.status})")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏ "–ß–∞—Ç/–ó–∞–≤–µ—Ä—à–∏—Ç—å"
        if booking.status == 'in_progress':
            print("   ‚úÖ –£ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏ '–ß–∞—Ç/–ó–∞–≤–µ—Ä—à–∏—Ç—å'")
        else:
            print("   ‚ùå –õ–æ–≥–∏–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
    
    print("\nüéØ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'new'")
    print("‚úÖ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ '–ü—Ä–∏–Ω—è—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å' –¥–ª—è –Ω–æ–≤—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π")
    print("‚úÖ –ü–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 'in_progress'")
    print("‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ –∫–∞—Ç–∞–ª–æ–≥!")

if __name__ == "__main__":
    test_booking_fix() 